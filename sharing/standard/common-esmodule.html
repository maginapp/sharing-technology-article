<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CommonJS 和 ES6 Module 究竟有什么区别？ | 分享技术资料-magina</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/sharing-technology-article/favicon.ico">
    <link rel="manifest" href="/sharing-technology-article/manifest.json">
    <meta name="description" content="CommonJS 和 ES6 Module 究竟有什么区别？">
    <meta name="keywords" content="CommonJS,ES6 Module">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/sharing-technology-article/assets/css/0.styles.3272b330.css" as="style"><link rel="preload" href="/sharing-technology-article/assets/js/app.efee8cae.js" as="script"><link rel="preload" href="/sharing-technology-article/assets/js/13.89a2d138.js" as="script"><link rel="preload" href="/sharing-technology-article/assets/js/3.821b8e0d.js" as="script"><link rel="preload" href="/sharing-technology-article/assets/js/75.1bfbe73c.js" as="script"><link rel="preload" href="/sharing-technology-article/assets/js/12.080f1848.js" as="script"><link rel="preload" href="/sharing-technology-article/assets/js/5.52b0c64e.js" as="script"><link rel="prefetch" href="/sharing-technology-article/assets/js/10.02a368ce.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/11.2b3d6139.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/14.b0cd9d52.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/15.96034a5c.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/16.b9c9c694.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/17.241d91f4.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/18.6f846859.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/19.0e2a9dd0.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/20.ea0554b0.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/21.56a486ea.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/22.295672ab.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/23.4f366210.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/24.be5158bf.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/25.b34be081.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/26.20414d2c.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/27.f4180c6e.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/28.cac9afec.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/29.a1376d3c.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/30.52b59fd5.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/31.6f9318c8.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/32.f1e7f1c4.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/33.d5343a30.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/34.f88be6e3.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/35.fbc320e3.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/36.bd2abffe.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/37.b463bf3f.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/38.8ddf708d.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/39.d733248d.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/4.7efa2cb1.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/40.c3af7038.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/41.d275240c.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/42.8388f0d0.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/43.d915b580.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/44.18a39903.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/45.d954818d.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/46.ce9500bb.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/47.33212199.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/48.eb00032c.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/49.a84d7c9b.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/50.1bdc7a64.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/51.5bdb80ab.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/52.5f2a2fbd.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/53.2e4ac162.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/54.fc1f01ce.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/55.a7973610.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/56.94bfbf29.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/57.e294010b.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/58.4b570088.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/59.b03a12f7.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/6.0180560f.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/60.ef9fea24.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/61.fa4c32f4.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/62.d8a28112.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/63.e9933c03.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/64.db03649e.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/65.d91b1d5d.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/66.99ef1ebe.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/67.2e7bc587.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/68.7d0af08e.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/69.5432a668.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/7.7cc41267.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/70.1ff43b55.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/71.4ee3b9d8.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/72.0cd5c5b6.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/73.ad029bd6.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/74.3d886101.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/76.50ffc299.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/77.92556235.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/78.11593f04.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/79.9c2f5bd1.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/8.aa5d0325.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/80.ceb59af8.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/9.0982cfe4.js"><link rel="prefetch" href="/sharing-technology-article/assets/js/vendors~flowchart.10ccd4af.js">
    <link rel="stylesheet" href="/sharing-technology-article/assets/css/0.styles.3272b330.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sharing-technology-article/" class="home-link router-link-active"><!----> <span class="site-name">分享技术资料-magina</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/sharing-technology-article/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/sharing-technology-article/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/sharing-technology-article/sharing/" class="nav-link router-link-active">
  Sharing
</a></div><div class="nav-item"><a href="/sharing-technology-article/interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="https://github.com/maginapp/sharing-technology-article/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issues
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/sharing-technology-article/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/sharing-technology-article/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/sharing-technology-article/sharing/" class="nav-link router-link-active">
  Sharing
</a></div><div class="nav-item"><a href="/sharing-technology-article/interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="https://github.com/maginapp/sharing-technology-article/issues" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issues
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>sharing</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/sharing-technology-article/sharing/" class="sidebar-link">Sharing articles</a></li><li><a href="/sharing-technology-article/sharing/utils-web.html" class="sidebar-link">常用工具网站</a></li><li><a href="/sharing-technology-article/sharing/sharing-blog.html" class="sidebar-link">博客</a></li><li><a href="/sharing-technology-article/sharing/software.html" class="sidebar-link">常用软件</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置与构建</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规范</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page theme-zoom-content"> <div class="theme-default-content content__default"><h1 id="commonjs-和-es6-module-究竟有什么区别？"><a href="#commonjs-和-es6-module-究竟有什么区别？" class="header-anchor">#</a> CommonJS 和 ES6 Module 究竟有什么区别？</h1> <div><blockquote><p>CommonJS 和 ES6 Module 究竟有什么区别？</p> <p>作者：FESKY</p> <p>链接：https://juejin.cn/post/6844904080955932680</p> <p>来源：掘金</p></blockquote></div> <p>作为前端开发者，你是否也曾有过疑惑，为什么可以代码中可以直接使用 <code>require</code> 方法加载模块，为什么加载第三方包的时候 Node 会知道选择哪个文件作为入口，以及常被问到的，为什么 ES6 Module export 基础数据类型的时候会有【引用类型】的效果？</p> <p>带着这些疑问和好奇，希望阅读这篇文章能解答你的疑惑。</p> <h2 id="commonjs-规范"><a href="#commonjs-规范" class="header-anchor">#</a> CommonJS 规范</h2> <p>在 ES6 之前，ECMAScript 并没有提供代码组织的方式，那时候通常是基于 IIFE 来实现“模块化”，随着 JavaScript 在前端大规模的应用，以及服务端 Javascript 的推动，原先浏览器端的模块规范不利于大规模应用。于是早期便有了 <a href="http://www.commonjs.org/" target="_blank" rel="noopener noreferrer">CommonJS 规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其目标是为了定义模块，提供通用的模块组织方式。</p> <h3 id="模块定义和使用"><a href="#模块定义和使用" class="header-anchor">#</a> 模块定义和使用</h3> <p>在 Commonjs 中，一个文件就是一个模块。定义一个模块导出通过 <code>exports</code> 或者 <code>module.exports</code> 挂载即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exports<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
复制代码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>导入一个模块也很简单，通过 <code>require</code> 对应模块拿到 <code>exports</code> 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./counter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>CommonJS</code> 的模块主要由原生模块 <code>module</code> 来实现，这个类上的一些属性对我们理解模块机制有很大帮助。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Module <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token comment">// 如果是 mainModule id 固定为 '.'，如果不是则为模块绝对路径</span>
  exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 模块最终 exports</span>
  filename<span class="token operator">:</span> <span class="token string">'/absolute/path/to/entry.js'</span><span class="token punctuation">,</span> <span class="token comment">// 当前模块的绝对路径</span>
  loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 模块是否已加载完毕</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 被该模块引用的模块</span>
  parent<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// 第一个引用该模块的模块</span>
  paths<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 模块的搜索路径</span>
   <span class="token string">'/absolute/path/to/node_modules'</span><span class="token punctuation">,</span>
   <span class="token string">'/absolute/path/node_modules'</span><span class="token punctuation">,</span>
   <span class="token string">'/absolute/node_modules'</span><span class="token punctuation">,</span>
   <span class="token string">'/node_modules'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="require-从哪里来？"><a href="#require-从哪里来？" class="header-anchor">#</a> require 从哪里来？</h3> <p>在编写 CommonJS 模块的时候，我们会使用 <code>require</code> 来加载模块，使用 <code>exports</code> 来做模块输出，还有 <code>module</code>，<code>__filename</code>, <code>__dirname</code> 这些变量，为什么它们不需要引入就能使用？</p> <p>原因是 Node 在解析 JS 模块时，会先按文本读取内容，然后将模块内容进行包裹，在外层裹了一个 function，传入变量。再通过 <code>vm.runInThisContext</code> 将字符串转成 <code>Function</code>形成作用域，避免全局污染。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">script</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'(function (exports, require, module, __filename, __dirname) { '</span><span class="token punctuation">,</span>
  <span class="token string">'\n});'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>于是在 CommmonJS 的模块中可以不需要 require，直接访问到这些方法，变量。</p> <p>参数中的 <code>module</code> 是当前模块的的 <code>module</code> 实例（尽管这个时候模块代码还没编译执行），<code>exports</code> 是 <code>module.exports</code> 的别名，最终被 <code>require</code> 的时候是输出 <code>module.exports</code> 的值。<code>require</code> 最终调用的也是 <code>Module._load</code> 方法。<code>__filename</code>，<code>__dirname</code> 则分别是当前模块在系统中的绝对路径和当前文件夹路径。</p> <h3 id="模块的查找过程"><a href="#模块的查找过程" class="header-anchor">#</a> 模块的查找过程</h3> <p>开发者在使用 require 时非常简单，但实际上为了兼顾各种写法，不同类型的模块，<code>node_modules</code> packages 等模块的查找过程稍微有点麻烦。</p> <p>首先，在创建模块对象时，会有 paths 属性，其值是由当前文件路径计算得到的，从当前目录一直到系统根目录的 <code>node_modules</code>。可以在模块中打印 <code>module.paths</code> 看看。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span> 
  <span class="token string">'/Users/evan/Desktop/demo/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/evan/Desktop/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/evan/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/node_modules'</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>除此之外，还会查找全局路径（如果存在的话）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
  execPath<span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>lib<span class="token operator">/</span>node_modules<span class="token punctuation">,</span> <span class="token comment">// 当前 node 执行文件相对路径下的 lib/node_modules</span>
  <span class="token constant">NODE_PATH</span><span class="token punctuation">,</span> <span class="token comment">// 全局变量 NODE_PATH</span>
  <span class="token constant">HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>node_modules<span class="token punctuation">,</span> <span class="token comment">// HOME 目录下的 .node_module</span>
  <span class="token constant">HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>node_libraries' <span class="token comment">// HOME 目录下的 .node-libraries</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>按照官方文档给出的<a href="https://nodejs.org/dist/latest-v12.x/docs/api/modules.html#modules_all_together" target="_blank" rel="noopener noreferrer">查找过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>已经足够详细，这里只给出大概流程。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>从 <span class="token constant">Y</span> 路径运行 <span class="token function">require</span><span class="token punctuation">(</span><span class="token constant">X</span><span class="token punctuation">)</span>

<span class="token number">1.</span> 如果 <span class="token constant">X</span> 是内置模块（比如 <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span>）<span class="token punctuation">)</span>
　　a<span class="token punctuation">.</span> 返回该模块。
　　b<span class="token punctuation">.</span> 不再继续执行。

<span class="token number">2.</span> 如果 <span class="token constant">X</span> 是以 <span class="token string">'/'</span> 开头、
   a<span class="token punctuation">.</span> 设置 <span class="token constant">Y</span> 为 <span class="token string">'/'</span>

<span class="token number">3.</span> 如果 <span class="token constant">X</span> 是以 <span class="token string">'./'</span> 或 <span class="token string">'/'</span> 或 <span class="token string">'../'</span> 开头
   a<span class="token punctuation">.</span> 依次尝试加载文件，如果找到则不再执行
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span><span class="token punctuation">)</span>
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span><span class="token punctuation">)</span><span class="token punctuation">.</span>js
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span><span class="token punctuation">)</span><span class="token punctuation">.</span>json
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node
   b<span class="token punctuation">.</span> 依次尝试加载目录，如果找到则不再执行
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span> <span class="token operator">+</span> <span class="token keyword">package</span><span class="token punctuation">.</span>json 中的 main 字段<span class="token punctuation">)</span><span class="token punctuation">.</span>js
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span> <span class="token operator">+</span> <span class="token keyword">package</span><span class="token punctuation">.</span>json 中的 main 字段<span class="token punctuation">)</span><span class="token punctuation">.</span>json
      <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token constant">Y</span> <span class="token operator">+</span> <span class="token constant">X</span> <span class="token operator">+</span> <span class="token keyword">package</span><span class="token punctuation">.</span>json 中的 main 字段<span class="token punctuation">)</span><span class="token punctuation">.</span>node
　　c<span class="token punctuation">.</span> 抛出 <span class="token string">&quot;not found&quot;</span>
<span class="token number">4.</span> 遍历 module paths 查找，如果找到则不再执行
<span class="token number">5.</span> 抛出 <span class="token string">&quot;not found&quot;</span>
复制代码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>模块查找过程会将软链替换为系统中的真实路径，例如 <code>lib/foo/node_moduels/bar</code> 软链到 <code>lib/bar</code>，<code>bar</code> 包中又 <code>require('quux')</code>，最终运行 <code>foo</code> module 时，<code>require('quux')</code> 的查找路径是 <code>lib/bar/node_moduels/quux</code> 而不是 <code>lib/foo/node_moduels/quux</code>。</p> <h3 id="模块加载相关"><a href="#模块加载相关" class="header-anchor">#</a> 模块加载相关</h3> <h4 id="mainmodule"><a href="#mainmodule" class="header-anchor">#</a> MainModule</h4> <p>当运行 <code>node index.js</code> 时，Node 调用 Module 类上的静态方法 <code>_load(process.argv[1])</code> 加载这个模块，并标记为主模块，赋值给 <code>process.mainModule</code> 和 <code>require.main</code>，可以通过这两个字段判断当前模块是主模块还是被 <code>require</code> 进来的。</p> <p><code>CommonJS</code> 规范是在代码运行时同步阻塞性地加载模块，在执行代码过程中遇到 <code>require(X)</code> 时会停下来等待，直到新的模块加载完成之后再继续执行接下去的代码。</p> <p><img src="https://maginapp.github.io/static-website/images/sharing/standard/common-es-mainmodule.webp" alt=""></p> <p>虽说是同步阻塞性，但这一步实际上非常快，和浏览器上阻塞性下载、解析、执行 <code>js</code> 文件不是一个级别，硬盘上读文件比网络请求快得多。</p> <h4 id="缓存和循环引用"><a href="#缓存和循环引用" class="header-anchor">#</a> 缓存和循环引用</h4> <p>文件模块查找挺耗时的，如果每次 require 都需要重新遍历文件夹查找，性能会比较差；还有在实际开发中，模块可能包含<strong>副作用</strong>代码，例如在模块顶层执行 <code>addEventListener</code> ，如果 require 过程中被重复执行多次可能会出现问题。</p> <p><code>CommonJS</code> 中的缓存可以解决重复查找和重复执行的问题。模块加载过程中会以模块绝对路径为 <code>key</code>, <code>module</code> 对象为 <code>value</code> 写入 <code>cache</code>。在读取模块的时候会优先判断是否已在缓存中，如果在，直接返回 <code>module.exports</code>；如果不在，则会进入模块查找的流程，找到模块之后再写入 <code>cache</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> a1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a1<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> a2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1 <span class="token operator">===</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>以上例子中，<code>require a.js</code> 并修改其中的 <code>foo</code> 属性，接着再次 <code>require a.js</code> 可以看到两次 <code>require</code> 结果是一样的。</p> <p>模块缓存可以打印 <code>require.cache</code> 进行查看。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> 
    <span class="token string">'/Users/evan/Desktop/demo/main.js'</span><span class="token operator">:</span> 
       Module <span class="token punctuation">{</span>
         id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
         exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
         parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
         filename<span class="token operator">:</span> <span class="token string">'/Users/evan/Desktop/demo/main.js'</span><span class="token punctuation">,</span>
         loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
         children<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
         paths<span class="token operator">:</span> 
          <span class="token punctuation">[</span> <span class="token string">'/Users/evan/Desktop/demo/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/evan/Desktop/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/evan/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/node_modules'</span>
          <span class="token punctuation">]</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'/Users/evan/Desktop/demo/a.js'</span><span class="token operator">:</span> 
       Module <span class="token punctuation">{</span>
         id<span class="token operator">:</span> <span class="token string">'/Users/evan/Desktop/demo/a.js'</span><span class="token punctuation">,</span>
         exports<span class="token operator">:</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
         parent<span class="token operator">:</span> 
          Module <span class="token punctuation">{</span>
            id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
            exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            filename<span class="token operator">:</span> <span class="token string">'/Users/evan/Desktop/demo/main.js'</span><span class="token punctuation">,</span>
            loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            children<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
            paths<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
         filename<span class="token operator">:</span> <span class="token string">'/Users/evan/Desktop/demo/a.js'</span><span class="token punctuation">,</span>
         loaded<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
         children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
         paths<span class="token operator">:</span> 
          <span class="token punctuation">[</span> <span class="token string">'/Users/evan/Desktop/demo/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/evan/Desktop/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/evan/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/Users/node_modules'</span><span class="token punctuation">,</span>
            <span class="token string">'/node_modules'</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>缓存还解决了循环引用的问题。举个例子，现在有模块 a require 模块 b；而模块 b 又 require 了模块 a。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in main, a.a1 = %j, a.a2 = %j'</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>a1<span class="token punctuation">,</span> a<span class="token punctuation">.</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// a.js</span>
exports<span class="token punctuation">.</span>a1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in a, b.done = %j'</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>a2 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// b.js</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in b, a.a1 = %j, a.a2 = %j'</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>a1<span class="token punctuation">,</span> a<span class="token punctuation">.</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>程序执行结果如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">in</span> b<span class="token punctuation">,</span> a<span class="token punctuation">.</span>a1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>a2 <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token keyword">in</span> main<span class="token punctuation">,</span> a<span class="token punctuation">.</span>a1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>a2 <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>实际上在模块 a 代码执行之前就已经创建了 Module 实例写入了缓存，此时代码还没执行，exports 是个<a href="https://github.com/nodejs/node/blob/9085c03806dbc9eb48e14c2afa49080deee0ee3c/lib/internal/modules/cjs/loader.js#L154" target="_blank" rel="noopener noreferrer">空对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'/Users/evan/Desktop/module/a.js'</span><span class="token operator">:</span> 
   Module <span class="token punctuation">{</span>
     exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>代码 <code>exports.a1 = true;</code> 修改了 <code>module.exports</code> 上的 <code>a1</code> 为 <code>true</code>, 这时候 <code>a2</code> 代码还没执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'/Users/evan/Desktop/module/a.js'</span><span class="token operator">:</span> 
   Module <span class="token punctuation">{</span>
     exports<span class="token operator">:</span> <span class="token punctuation">{</span>
      a1<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
     <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>进入 <code>b</code> 模块，<code>require a.js</code> 时发现缓存上已经存在了，获取 <code>a</code> 模块上的 <code>exports</code> 。打印 <code>a1, a2</code> 分别是 <code>true</code>，和 <code>undefined</code>。</p> <p>运行完 <code>b</code> 模块，继续执行 <code>a</code> 模块剩余的代码，<code>exports.a2 = true;</code> 又往 <code>exports</code> 对象上增加了 <code>a2</code> 属性，此时 <code>module a</code> 的 <code>export</code> 对象 <code>a1, a2</code> 均为 <code>true</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exports<span class="token operator">:</span> <span class="token punctuation">{</span> 
  a1<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  a2<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再回到 <code>main</code> 模块，由于 <code>require('./a.js')</code> 得到的是 <code>module a</code> <code>export</code> 对象的引用，这时候打印 <code>a1, a2</code> 就都为 <code>true</code>。</p> <p><strong>小结：</strong></p> <p><code>CommonJS</code> 模块加载过程是同步阻塞性地加载，在模块代码被运行前就已经写入了 <code>cache</code>，同一个模块被多次 <code>require</code> 时只会执行一次，重复的 <code>require</code> 得到的是相同的 <code>exports</code> 引用。</p> <p><strong>值得留意：</strong> <code>cache key</code> 使用的是模块在系统中的绝对位置，由于<strong>模块调用位置的不同</strong>，相同的 <code>require('foo')</code> 代码并不能保证返回的是统一个对象引用。我之前恰巧就遇到过，<a href="https://github.com/eggjs/egg/issues/3591#issuecomment-503515164" target="_blank" rel="noopener noreferrer">两次 require('egg-core') 但是他们并不相等<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="es6-模块"><a href="#es6-模块" class="header-anchor">#</a> ES6 模块</h2> <p><code>ES6</code> 模块是前端开发同学更为熟悉的方式，使用 <code>import</code>, <code>export</code> 关键字来进行模块输入输出。<code>ES6</code> 不再是使用闭包和函数封装的方式进行模块化，而是从语法层面提供了模块化的功能。</p> <p><code>ES6</code> 模块中不存在 <code>require</code>, <code>module.exports</code>, <code>__filename</code> 等变量，<code>CommonJS</code> 中也不能使用 <code>import</code>。两种规范是不兼容的，一般来说平日里写的 <code>ES6</code> 模块代码最终都会经由 <code>Babel</code>, <code>Typescript</code> 等工具处理成 <code>CommonJS</code> 代码。</p> <p>使用 <code>Node</code> 原生 <code>ES6</code> 模块需要将 <code>js</code> 文件后缀改成 <code>mjs</code>，或者 <code>package.json</code> &quot;type&quot; 字段改为 &quot;module&quot;，通过这种形式告知 <code>Node</code> 使用 <code>ES Module</code> 的形式加载模块。</p> <h3 id="es6-模块-加载过程"><a href="#es6-模块-加载过程" class="header-anchor">#</a> ES6 模块 加载过程</h3> <p>ES6 模块的加载过程分为三步：</p> <h4 id="_1-查找，下载，解析，构建所有模块实例。"><a href="#_1-查找，下载，解析，构建所有模块实例。" class="header-anchor">#</a> 1. 查找，下载，解析，构建所有模块实例。</h4> <p>ES6 模块会在程序开始前先根据模块关系查找到所有模块，生成一个无环关系图，并将所有模块实例都创建好，这种方式天然地避免了循环引用的问题，当然也有模块加载缓存，重复 import 同一个模块，只会执行一次代码。</p> <h4 id="_2-在内存中腾出空间给即将-export-的内容（此时尚未写入-export-value）。然后使-import-和-export-指向内存中的这些空间，这个过程也叫连接。"><a href="#_2-在内存中腾出空间给即将-export-的内容（此时尚未写入-export-value）。然后使-import-和-export-指向内存中的这些空间，这个过程也叫连接。" class="header-anchor">#</a> 2. 在内存中腾出空间给即将 export 的内容（此时尚未写入 export value）。然后使 import 和 export 指向内存中的这些空间，这个过程也叫连接。</h4> <p>这一步完成的工作是 <code>living binding import export</code>，借助下面的例子来帮助理解。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counter.js</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token punctuation">,</span>
  increment
<span class="token punctuation">}</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'counter.cjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

counter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>上面 <code>CommonJS</code> 的例子执行结果很好理解，修改 <code>count++</code> 修改的是模块内的基础数据类型变量，不会改变 <code>exports.count</code>，所以打印结果认为 <code>1</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counter.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">increment</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// main.mjs</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> increment<span class="token punctuation">,</span> count <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./counter.mjs'</span>

<span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>从结果上看使用 <code>ES6</code> 模块的写法，当 <code>export</code> 的变量被修改时，会影响 <code>import</code> 的结果。这个功能的实现就是 <code>living binding</code>，具体规范底层如何实现可以暂时不管，但是知道 <code>living binding</code> 比网上文章描述为 &quot;ES6 模块输出的是值的引用&quot; 更好理解。</p> <p>更接近 <code>ES6</code> 模块的 <code>CommonJS</code> 代码可以是下面这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exports<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">increment</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exports<span class="token punctuation">.</span>counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3-运行模块代码将变量的实际值填写在第二步生成的空间中。"><a href="#_3-运行模块代码将变量的实际值填写在第二步生成的空间中。" class="header-anchor">#</a> 3. 运行模块代码将变量的实际值填写在第二步生成的空间中。</h4> <p>到第三步，会基于第一步生成的无环图进行深度优先后遍历填值，如果这个过程中访问了尚未初始化完成的空间，会抛出异常。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a1 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> b <span class="token keyword">from</span> <span class="token string">'./b.mjs'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a2 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// b.mjs</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> a1<span class="token punctuation">,</span> a2 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.mjs'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面的例子会在运行时抛出异常 <code>ReferenceError: Cannot access 'a1' before initialization</code>。如果改成 <code>import * as a from 'a.mjs'</code> 可以看到 <code>a</code> 模块中 <code>export</code> 的对象已经占好坑了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// b.mjs</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> a <span class="token keyword">from</span> <span class="token string">'./a.mjs'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>将输出 <code>{ a1: &lt;uninitialized&gt;, a2: &lt;uninitialized&gt; }</code> 可以看出，ES6 模块为 export 的变量预留了空间，不过尚未赋值。这里和 <code>CommonJS</code> 不一样，<code>CommonJS</code> 到这里是知道 <code>a1</code> 为 <code>true</code>, <code>a2</code> 为 <code>undefined</code></p> <p>除此之外，我们还能推导出一些 ES6 模块和 <code>CommonJS</code> 的差异点：</p> <ul><li><code>CommonJS</code> 可以在运行时使用变量进行 require, 例如 <code>require(path.join('xxxx', 'xxx.js'))</code>，而静态 <code>import</code> 语法（还有<code>动态 import</code>，返回 <code>Promise</code>）不行，因为 ES6 模块会先解析所有模块再执行代码。</li></ul> <p><img src="https://maginapp.github.io/static-website/images/sharing/standard/common-es-path.webp" alt=""></p> <ul><li><code>require</code> 会将完整的 <code>exports</code> 对象引入，<code>import</code> 可以只 <code>import</code> 部分必要的内容，这也是为什么使用 <code>Tree Shaking</code> 时必须使用 ES6 模块 的写法。</li> <li><code>import</code> 另一个模块没有 <code>export</code> 的变量，在代码执行前就会报错，而 <code>CommonJS</code> 是在模块运行时才报错。</li></ul> <h3 id="为什么平时开发可以混写？"><a href="#为什么平时开发可以混写？" class="header-anchor">#</a> 为什么平时开发可以混写？</h3> <p>前面提到 <code>ES6</code> 模块和 <code>CommonJS</code> 模块有很大差异，不能直接混着写。这和开发中表现是不一样的，原因是开发中写的 ES6 模块最终都会被打包工具处理成 <code>CommonJS</code> 模块，以便兼容更多环境，同时也能和当前社区普通的 <code>CommonJS</code> 模块融合。</p> <p>在转换的过程中会产生一些困惑，比如说：</p> <h4 id="esmodule-是什么？干嘛用的？"><a href="#esmodule-是什么？干嘛用的？" class="header-anchor">#</a> <code>__esModule</code> 是什么？干嘛用的？</h4> <p>使用转换工具处理 ES6 模块的时候，常看到打包之后出现 <code>__esModule</code> 属性，字面意思就是将其标记为 <code>ES6 Module</code>。这个变量存在的作用是为了方便在引用模块的时候加以处理。</p> <p>例如 ES6 模块中的 <code>export default</code> 在转化成 <code>CommonJS</code> 时会被挂载到 <code>exports['default']</code> 上，当运行 <code>require('./a.js')</code> 时 是不能直接读取到 <code>default</code> 上的值的，为了和 ES6 中 <code>import a from './a.js'</code> 的行为一致，会基于 <code>__esModule</code> 判断处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'./a'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>转化后</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a.js</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _a2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_a2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>a</code> 模块 <code>export defualt</code> 会被转换成 <code>exports.default = 1;</code>，这也是平时前端项目开发中使用 <code>require</code> 为什么还常常需要 <code>.default</code> 才能取到目标值的原因。</p> <p>接着当运行 <code>import a from './a.js'</code> 时，<code>es module</code> 预期的是返回 <code>export</code> 的内容。工具会将代码转换为 <code>_interopRequireDefault</code> 包裹，在里面判断是否为 <code>esModule</code>，是的话直接返回，如果是 <code>commonjs</code> 模块的话则包裹一层 <code>{default: obj}</code>，最后获取 a 的值时，也会被装换成 <code>_a1.default</code>。</p> <h2 id="相关链接"><a href="#相关链接" class="header-anchor">#</a> 相关链接</h2> <ul><li><a href="https://nodejs.org/api/modules.html" target="_blank" rel="noopener noreferrer">nodejs.org/api/modules…<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/" target="_blank" rel="noopener noreferrer">hacks.mozilla.org/2018/03/es-…<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://segmentfault.com/a/1190000004940294" target="_blank" rel="noopener noreferrer">segmentfault.com/a/119000000…<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.infoq.cn/article/nodejs-module-mechanism" target="_blank" rel="noopener noreferrer">www.infoq.cn/article/nod…<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!---->  <!----></main></div><div class="global-ui"><!----><!----><div class="vuepress-eqn"></div><span class="vuepress-eq"></span></div></div>
    <script src="/sharing-technology-article/assets/js/app.efee8cae.js" defer></script><script src="/sharing-technology-article/assets/js/13.89a2d138.js" defer></script><script src="/sharing-technology-article/assets/js/3.821b8e0d.js" defer></script><script src="/sharing-technology-article/assets/js/75.1bfbe73c.js" defer></script><script src="/sharing-technology-article/assets/js/12.080f1848.js" defer></script><script src="/sharing-technology-article/assets/js/5.52b0c64e.js" defer></script>
  </body>
</html>
